==============================================================================
# Overview

## 'UserDetailsService' interface
* _xem `~\security\SpringSecurity\Authentication\type\UsernamePassword.md` để hiểu_

## UserDetails
* https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/user-details.html

## JdbcUserDetailsManager
* -> extends **`JdbcDaoImpl`** to provide **`management of UserDetails`** through the **UserDetailsManager interface**
* -> **UserDetails-based authentication** is used by Spring Security when it is **`configured to accept a username/password for authentication`**

## JdbcDaoImpl
* -> implements **`UserDetailsService`** to provide **`support for username-and-password-based authentication`** that is retrieved by **`using JDBC`**

==============================================================================
> hiểu được default table nó sẽ dùng là gì để custom

# Default Schema
* -> Spring Security provides the **`corresponding default schemas`** used with the **`default queries`** for **`JDBC-based authentication`**
* _we need to adjust the schema to match any customizations to the queries and the database dialect we use_

## User Schema (org/springframework/security/core/userdetails/jdbc/users.ddl)
* -> **`JdbcDaoImpl requires tables`** to load **the password, account status (enabled or disabled)** and **a list of authorities (roles)** for the user

```sql - Default User Schema
create table users(
	username varchar_ignorecase(50) not null primary key,
	password varchar_ignorecase(500) not null,
	enabled boolean not null
);

create table authorities (
	username varchar_ignorecase(50) not null,
	authority varchar_ignorecase(50) not null,
	constraint fk_authorities_users foreign key(username) references users(username)
);
create unique index ix_auth_username on authorities (username,authority);
```

## Group Schema (if used)
* -> **`if our application uses groups`**, we need to provide the groups schema:

```sql
create table groups (
	id bigint generated by default as identity(start with 0) primary key,
	group_name varchar_ignorecase(50) not null
);

create table group_authorities (
	group_id bigint not null,
	authority varchar(50) not null,
	constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

create table group_members (
	id bigint generated by default as identity(start with 0) primary key,
	username varchar(50) not null,
	group_id bigint not null,
	constraint fk_group_members_group foreign key(group_id) references groups(id)
);
```

==============================================================================
> trước khi ta có thể configure **JdbcUserDetailsManager**, ta cần tạo **DataSource** trước

# Setting up a DataSource

```java - set up an "embedded DataSource" that is initialized with the "default user schema"
@Bean
DataSource dataSource() {
	return new EmbeddedDatabaseBuilder()
		.setType(H2)
		.addScript(JdbcDaoImpl.DEFAULT_USER_SCHEMA_DDL_LOCATION)
		.build();
}
```

==============================================================================
# JdbcUserDetailsManager Bean

```java - Example:
// use Spring Boot CLI to encode a password value of password and get the encoded password of {bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW

@Bean
UserDetailsManager users(DataSource dataSource) {
	UserDetails user = User.builder()
		.username("user")
		.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
		.roles("USER")
		.build();
	UserDetails admin = User.builder()
		.username("admin")
		.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
		.roles("USER", "ADMIN")
		.build();
	JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
	users.createUser(user);
	users.createUser(admin);
	return users;
}
```

